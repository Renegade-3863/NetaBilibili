<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>上传视频</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:16px}
    .box{max-width:720px}
    .row{margin:12px 0}
    input[type=file]{display:block;margin-top:8px}
    progress{width:100%;height:20px}
    .log{white-space:pre-wrap;background:#f8f8f8;border:1px solid #eee;padding:8px;border-radius:6px;margin-top:8px}
    a.btn{padding:6px 10px;border:1px solid #ccc;border-radius:6px;text-decoration:none}
  </style>
</head>
<body>
  <div class="box">
    <div class="row" style="display:flex;align-items:center;gap:12px">
      <a href="/SimpleHttp/index.html" class="btn">返回列表</a>
      <h2 style="margin:0">上传视频</h2>
    </div>
    <div class="row">
      <label>选择文件<input id="file" type="file" accept="video/*"></label>
    </div>
    <div class="row">
      <button id="uploadBtn">开始上传</button>
    </div>
    <div class="row">
      <progress id="bar" max="100" value="0"></progress>
  <div id="stat"></div>
  <div id="meta" style="margin-top:6px;color:#666"></div>
    </div>
    <div id="log" class="log" hidden></div>
    <div id="result" class="row"></div>
  </div>
  <script>
  const $ = (s)=>document.querySelector(s);
  const fmt = (n)=> n>1e9? (n/1e9).toFixed(2)+' GB' : n>1e6? (n/1e6).toFixed(2)+' MB' : n>1e3? (n/1e3).toFixed(2)+' KB' : n+' B';

  let fileDurationSec = 0;
  $('#file').addEventListener('change', ()=>{
    const f = $('#file').files[0];
    fileDurationSec = 0;
    $('#meta').textContent = '';
    if (!f) return;
    const v = document.createElement('video');
    v.preload = 'metadata';
    v.src = URL.createObjectURL(f);
    v.onloadedmetadata = () => {
      URL.revokeObjectURL(v.src);
      fileDurationSec = Math.round(v.duration || 0);
      $('#meta').textContent = `时长: ${fileDurationSec}s`;
    };
    v.onerror = () => {
      URL.revokeObjectURL(v.src);
    };
  });

  $('#uploadBtn').addEventListener('click', ()=>{
    const f = $('#file').files[0];
    if(!f){ alert('请选择文件'); return; }
    const url = '/upload/' + encodeURIComponent(f.name);

    const xhr = new XMLHttpRequest();
    xhr.open('PUT', url);
    xhr.responseType = 'json';
    // 传递视频时长（秒）给后端
    try { xhr.setRequestHeader('X-Video-Duration', String(fileDurationSec||0)); } catch(e) {}

    const t0 = Date.now();
    xhr.upload.onprogress = (e)=>{
      if(e.lengthComputable){
        const p = Math.round(e.loaded*100/e.total);
        $('#bar').value = p;
        const dt = (Date.now()-t0)/1000;
        const speed = dt>0? fmt(e.loaded/dt)+'/s' : '';
        $('#stat').textContent = `已上传 ${fmt(e.loaded)} / ${fmt(e.total)} (${p}%)  速度 ${speed}`;
      }
    };
    xhr.onload = ()=>{
      const ok = xhr.status >= 200 && xhr.status < 300;
      $('#log').hidden = false;
      $('#log').textContent = `HTTP ${xhr.status} ${xhr.statusText}\n` + (typeof xhr.response === 'object' ? JSON.stringify(xhr.response) : xhr.responseText || '');
      if(ok){
        try{
          const res = typeof xhr.response === 'object' ? xhr.response : JSON.parse(xhr.responseText||'{}');
          const path = res && res.path ? res.path : ('/static/uploads/' + encodeURIComponent(f.name));
          $('#result').innerHTML = `上传完成。<a href="/routers/player.html?file=${encodeURIComponent(path)}&title=${encodeURIComponent(f.name)}">点击播放</a>`;
        }catch(e){ /* ignore */ }
      }
    };
    xhr.onerror = ()=>{
      $('#log').hidden = false;
      $('#log').textContent = '网络错误，上传失败';
    };
    xhr.send(f);
  });
  </script>
</body>
</html>
